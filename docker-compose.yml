version: "3.9"

services:
  relay:
    build:
      context: .
      dockerfile: docker/relay.Dockerfile
    container_name: aria-relay
    # Run the relay in Pupil Core mode, connecting to Pupil Remote
    # running on the host machine.
    command: [
      "python",
      "aria_stream_relay.py",
      "--mode",
      "pupil",
      "--endpoint",
      "tcp://0.0.0.0:5555",
      "--pupil-host",
      "host.docker.internal",
      "--pupil-port",
      "50020",
      "--pupil-topic",
      "gaze.",
      "--pupil-confidence-threshold",
      "0.6"
    ]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "5555:5555"
    networks:
      - aria-net

  backend:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    container_name: aria-backend
    depends_on:
      - relay
    environment:
      - ARIA_ZMQ_ENDPOINT=tcp://aria-relay:5555
      - PATCH_ASSETS_DIR=/app/assets/patches
    volumes:
      # Mount local assets so new generated patches are visible without
      # rebuilding the image.
      - ./assets:/app/assets:ro
    ports:
      - "8000:8000"
    networks:
      - aria-net

  frontend:
    build:
      context: .
      dockerfile: docker/frontend.Dockerfile
    container_name: aria-frontend
    depends_on:
      - backend
    ports:
      - "8080:8080"
    networks:
      - aria-net

networks:
  aria-net:
    driver: bridge
