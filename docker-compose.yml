version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    container_name: aria-backend
    environment:
      - PATCH_ASSETS_DIR=/app/assets/patches
      # The following are needed for the backend to connect to Pupil Core
      # running on the host machine.
      - PUPIL_HOST=host.docker.internal
      - PUPIL_REMOTE_PORT=50020
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Mount local assets so new generated patches are visible without
      # rebuilding the image.
      - ./assets:/app/assets:ro
    ports:
      - "8000:8000"
    networks:
      - aria-net

  generation:
    build:
      context: .
      dockerfile: docker/generation.Dockerfile
    container_name: aria-generation
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./assets:/app/assets:rw
    ports:
      - "8001:8001"
    networks:
      - aria-net

  frontend:
    build:
      context: .
      dockerfile: docker/frontend.Dockerfile
    container_name: aria-frontend
    depends_on:
      - backend
    ports:
      - "8080:8080"
    networks:
      - aria-net

networks:
  aria-net:
    driver: bridge
